{% extends 'faculty_requirement/admin/base.html' %}
{% load static %}

{% block page_title %}Designations{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- CREATE / EDIT FORM -->
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">

        <h5 class="card-title mb-3" id="formTitle">Create Designation</h5>

        <form method="post" action="{% url 'designation' %}" id="desigForm">
          {% csrf_token %}

          <input type="hidden" name="operation" id="formOperation" value="create">
          <input type="hidden" name="id" id="formDesigId">

          <div class="mb-3">
            <label for="desigName" class="form-label">Designation Name</label>
            <input type="text"
                   class="form-control"
                   id="desigName"
                   name="name"
                   placeholder="e.g., Assistant Professor"
                   required>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary" id="formSubmitBtn">
              <i class="fa fa-plus me-2"></i>Create
            </button>
            <button type="button"
                    class="btn btn-light d-none"
                    id="cancelEditBtn">
              Cancel Edit
            </button>
          </div>

        </form>

      </div>
    </div>
  </div>

  <!-- LIST TABLE -->
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-body">

        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="card-title m-0">All Designations</h5>
          <div class="input-group" style="max-width: 280px;">
            <span class="input-group-text"><i class="fa fa-search"></i></span>
            <input id="desigSearch" type="text" class="form-control" placeholder="Search...">
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle" id="desigTable">
            <thead>
              <tr>
                <th style="width:60px;">#</th>
                <th>Name</th>
                <th class="text-end" style="width:160px;">Actions</th>
              </tr>
            </thead>
            <tbody>

              {% for item in designations %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td class="desig-name">{{ item.name }}</td>
                <td class="text-end">

                  <!-- INLINE EDIT -->
                  <button type="button"
                          class="btn btn-sm btn-outline-primary me-2 edit-btn"
                          data-id="{{ item.id }}"
                          data-name="{{ item.name }}">
                    <i class="fa fa-edit me-1"></i>Edit
                  </button>

                  <!-- INLINE DELETE -->
                  <button type="button"
                          class="btn btn-sm btn-outline-danger delete-btn"
                          data-id="{{ item.id }}">
                    <i class="fa fa-trash me-1"></i>Delete
                  </button>

                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center text-muted">
                  No designations found.
                </td>
              </tr>
              {% endfor %}

            </tbody>
          </table>
        </div>

        <!-- HIDDEN DELETE FORM -->
        <form method="post" action="{% url 'designation' %}"
              id="deleteForm" class="d-none">
          {% csrf_token %}
          <input type="hidden" name="operation" value="delete">
          <input type="hidden" name="id" id="deleteFormId">
        </form>

      </div>
    </div>
  </div>
</div>

<!-- JAVASCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', function () {

  const formTitle = document.getElementById('formTitle');
  const formOperation = document.getElementById('formOperation');
  const formDesigId = document.getElementById('formDesigId');
  const desigName = document.getElementById('desigName');
  const submitBtn = document.getElementById('formSubmitBtn');
  const cancelBtn = document.getElementById('cancelEditBtn');

  /* ======================
     INLINE EDIT
  ====================== */
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function () {

      formTitle.textContent = 'Edit Designation';
      formOperation.value = 'edit';
      formDesigId.value = this.dataset.id;

      desigName.value = this.dataset.name;

      submitBtn.innerHTML = '<i class="fa fa-save me-2"></i>Update';
      submitBtn.classList.remove('btn-primary');
      submitBtn.classList.add('btn-warning');

      cancelBtn.classList.remove('d-none');

      desigName.focus();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });

  /* ======================
     CANCEL EDIT
  ====================== */
  cancelBtn.addEventListener('click', function () {

    formTitle.textContent = 'Create Designation';
    formOperation.value = 'create';
    formDesigId.value = '';
    desigName.value = '';

    submitBtn.innerHTML = '<i class="fa fa-plus me-2"></i>Create';
    submitBtn.classList.remove('btn-warning');
    submitBtn.classList.add('btn-primary');

    cancelBtn.classList.add('d-none');
  });

  /* ======================
     INLINE DELETE (NO LAG)
  ====================== */
  let activeDeleteBtn = null;

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.stopPropagation();

      if (activeDeleteBtn && activeDeleteBtn !== this) {
        resetDelete(activeDeleteBtn);
      }

      if (!this.classList.contains('confirming')) {
        this.classList.add('confirming');
        this.classList.remove('btn-outline-danger');
        this.classList.add('btn-danger');
        this.innerHTML = '<i class="fa fa-check me-1"></i>Confirm';
        activeDeleteBtn = this;
        return;
      }

      document.getElementById('deleteFormId').value = this.dataset.id;
      document.getElementById('deleteForm').submit();
    });
  });

  function resetDelete(btn) {
    btn.classList.remove('confirming', 'btn-danger');
    btn.classList.add('btn-outline-danger');
    btn.innerHTML = '<i class="fa fa-trash me-1"></i>Delete';
  }

  document.addEventListener('click', function () {
    if (activeDeleteBtn) {
      resetDelete(activeDeleteBtn);
      activeDeleteBtn = null;
    }
  });

  /* ======================
     SEARCH FILTER
  ====================== */
  document.getElementById('desigSearch').addEventListener('input', function () {
    const q = this.value.toLowerCase();
    document.querySelectorAll('#desigTable tbody tr').forEach(tr => {
      const name = tr.querySelector('.desig-name')?.textContent.toLowerCase() || '';
      tr.style.display = name.includes(q) ? '' : 'none';
    });
  });

});
</script>

{% endblock %}
