{% extends 'faculty_requirement/admin/base.html' %}
{% load static %}

{% block page_title %}Degrees{% endblock %}

{% block content %}
<div class="row g-4">

  <!-- ================= CREATE / EDIT FORM ================= -->
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">

        <h5 class="card-title mb-3" id="formTitle">Create Degree</h5>

        <form method="post" action="{% url 'degree' %}" id="degreeForm">
          {% csrf_token %}

          <input type="hidden" name="operation" id="formOperation" value="create">
          <input type="hidden" name="id" id="formDegreeId">

          <!-- DEGREE CODE -->
          <div class="mb-3">
            <label class="form-label">Degree Code</label>
            <input type="text"
                   class="form-control"
                   id="degreeCode"
                   name="degree_code"
                   placeholder="e.g., BE, BTECH, ME"
                   required>
          </div>

          <!-- DEGREE NAME -->
          <div class="mb-3">
            <label class="form-label">Degree Name</label>
            <input type="text"
                   class="form-control"
                   id="degreeName"
                   name="degree"
                   placeholder="e.g., Bachelor of Engineering"
                   required>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary" id="formSubmitBtn">
              <i class="fa fa-plus me-2"></i>Create
            </button>

            <button type="button"
                    class="btn btn-light d-none"
                    id="cancelEditBtn">
              Cancel Edit
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <!-- ================= DEGREE LIST ================= -->
  <div class="col-12 col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-body">

        <div class="d-flex align-items-center justify-content-between mb-3">
          <h5 class="card-title m-0">All Degrees</h5>
          <div class="input-group" style="max-width: 280px;">
            <span class="input-group-text"><i class="fa fa-search"></i></span>
            <input id="degreeSearch" type="text" class="form-control" placeholder="Search...">
          </div>
        </div>

        <div class="table-responsive">
          <table class="table align-middle" id="degreeTable">
            <thead>
              <tr>
                <th style="width:60px;">#</th>
                <th>Code</th>
                <th>Degree</th>
                <th class="text-end" style="width:160px;">Actions</th>
              </tr>
            </thead>
            <tbody>

              {% for item in degrees %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td class="degree-code">{{ item.degree_code }}</td>
                <td class="degree-name">{{ item.degree }}</td>
                <td class="text-end">

                  <!-- EDIT -->
                  <button type="button"
                          class="btn btn-sm btn-outline-primary me-2 edit-btn"
                          data-id="{{ item.id }}"
                          data-code="{{ item.degree_code }}"
                          data-name="{{ item.degree }}">
                    <i class="fa fa-edit me-1"></i>Edit
                  </button>

                  <!-- DELETE -->
                  <button type="button"
                          class="btn btn-sm btn-outline-danger delete-btn"
                          data-id="{{ item.id }}">
                    <i class="fa fa-trash me-1"></i>Delete
                  </button>

                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted">
                  No degrees found.
                </td>
              </tr>
              {% endfor %}

            </tbody>
          </table>
        </div>

        <!-- HIDDEN DELETE FORM -->
        <form method="post" action="{% url 'degree' %}" id="deleteForm" class="d-none">
          {% csrf_token %}
          <input type="hidden" name="operation" value="delete">
          <input type="hidden" name="id" id="deleteFormId">
        </form>

      </div>
    </div>
  </div>
</div>

<!-- ================= JAVASCRIPT ================= -->
<script>
document.addEventListener('DOMContentLoaded', function () {

  const formTitle = document.getElementById('formTitle');
  const formOperation = document.getElementById('formOperation');
  const formDegreeId = document.getElementById('formDegreeId');
  const degreeCode = document.getElementById('degreeCode');
  const degreeName = document.getElementById('degreeName');
  const submitBtn = document.getElementById('formSubmitBtn');
  const cancelBtn = document.getElementById('cancelEditBtn');

  /* ===== INLINE EDIT ===== */
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      formTitle.textContent = 'Edit Degree';
      formOperation.value = 'edit';
      formDegreeId.value = this.dataset.id;

      degreeCode.value = this.dataset.code;
      degreeName.value = this.dataset.name;

      submitBtn.innerHTML = '<i class="fa fa-save me-2"></i>Update';
      submitBtn.classList.replace('btn-primary', 'btn-warning');

      cancelBtn.classList.remove('d-none');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });

  /* ===== CANCEL EDIT ===== */
  cancelBtn.addEventListener('click', function () {
    formTitle.textContent = 'Create Degree';
    formOperation.value = 'create';
    formDegreeId.value = '';

    degreeCode.value = '';
    degreeName.value = '';

    submitBtn.innerHTML = '<i class="fa fa-plus me-2"></i>Create';
    submitBtn.classList.replace('btn-warning', 'btn-primary');

    cancelBtn.classList.add('d-none');
  });

  /* ===== INLINE DELETE (CONFIRM CLICK) ===== */
  let activeDeleteBtn = null;

  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.stopPropagation();

      if (activeDeleteBtn && activeDeleteBtn !== this) {
        resetDelete(activeDeleteBtn);
      }

      if (!this.classList.contains('confirming')) {
        this.classList.add('confirming', 'btn-danger');
        this.classList.remove('btn-outline-danger');
        this.innerHTML = '<i class="fa fa-check me-1"></i>Confirm';
        activeDeleteBtn = this;
        return;
      }

      document.getElementById('deleteFormId').value = this.dataset.id;
      document.getElementById('deleteForm').submit();
    });
  });

  function resetDelete(btn) {
    btn.classList.remove('confirming', 'btn-danger');
    btn.classList.add('btn-outline-danger');
    btn.innerHTML = '<i class="fa fa-trash me-1"></i>Delete';
  }

  document.addEventListener('click', function () {
    if (activeDeleteBtn) {
      resetDelete(activeDeleteBtn);
      activeDeleteBtn = null;
    }
  });

  /* ===== SEARCH FILTER ===== */
  document.getElementById('degreeSearch').addEventListener('input', function () {
    const q = this.value.toLowerCase();
    document.querySelectorAll('#degreeTable tbody tr').forEach(tr => {
      const code = tr.querySelector('.degree-code')?.textContent.toLowerCase() || '';
      const name = tr.querySelector('.degree-name')?.textContent.toLowerCase() || '';
      tr.style.display = (code.includes(q) || name.includes(q)) ? '' : 'none';
    });
  });

});
</script>

{% endblock %}
