{% extends "faculty_requirement/base.html" %}
{% load static %}

{% block page_title %}Educational Qualifications{% endblock %}
{% block header_meta %}
  <div>Provide details of your Educational Qualifications</div>
{% endblock %}

{% block extra_css %}
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Calibri','Segoe UI',sans-serif; background:#f8f9fa; padding:20px; color:#333; }
    .container{ max-width:1000px; margin:0 auto; background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1); overflow:hidden; border:1px solid #ddd; }
    .header{ background:#003366; color:#fff; padding:20px; text-align:center; border-bottom:4px solid #ffcc00; }
    .header h1{ font-size:24px; margin-bottom:5px; font-weight:600; }
    .header p{ font-size:14px; opacity:.9; }
    .form-section{ padding:25px; }
    .section-title{ color:#003366; font-size:18px; font-weight:600; margin:25px 0 15px; padding-bottom:8px; border-bottom:2px solid #e0e0e0; }
    .form-row{ display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px; }
    .form-group{ flex:1; min-width:200px; margin-bottom:15px; }
    label{ display:block; margin-bottom:5px; color:#003366; font-weight:500; font-size:14px; }
    .required:after{ content:" *"; color:#d32f2f; }
    .form-control, select, textarea{ width:100%; padding:8px 12px; border:1px solid #ccc; border-radius:4px; font-size:14px; }
    .education-block{ background:#f5f7fa; border:1px solid #ddd; border-radius:5px; padding:15px; margin-bottom:15px; position:relative; }
    .education-block:before{ content: attr(data-index); position:absolute; top:-10px; left:15px; background:#003366; color:#fff; width:20px; height:20px; border-radius:50%; text-align:center; line-height:20px; font-size:12px; }
    .education-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #ddd; }
    .education-header h3{ font-size:16px; color:#003366; margin:0; }
    .btn{ padding:8px 20px; border:none; border-radius:4px; cursor:pointer; font-size:14px; transition:.3s; }
    .btn-add{ background:#e9ecef; color:#003366; border:1px dashed #adb5bd; width:100%; margin:10px 0; }
    .btn-prev{ background:#6c757d; color:#fff; }
    .btn-next{ background:#003366; color:#fff; }
    .btn-remove{ background:#dc3545; color:#fff; font-size:12px; padding:5px 10px; }
    .button-group{ display:flex; justify-content:space-between; margin-top:30px; padding-top:20px; border-top:1px solid #eee; }
    .instructions{ background:#e7f1ff; border-left:3px solid #003366; padding:10px 15px; margin-bottom:20px; font-size:13px; }
    .error-box{ background:#ffe8e8; border-left:3px solid #dc3545; padding:10px 15px; margin-bottom:15px; font-size:13px; color:#7a1c1c; }
    .success-note{ display:block; color:#28a745; margin-top:5px; font-size:12px; }
    .full-width{ flex:1 0 100%; }
    .help-text{ display:block; color:#6c757d; font-size:12px; margin-top:5px; }
    @media (max-width:768px){
      .form-group{ min-width:100%; }
      .button-group{ flex-direction:column; gap:10px; }
      .btn{ width:100%; }
      .education-header{ flex-direction:column; align-items:flex-start; gap:10px; }
    }
  </style>
{% endblock %}

{% block content %}

    <form method="post" enctype="multipart/form-data" id="eduForm">
      {% csrf_token %}

      <div class="instructions">
        <strong>Required Qualifications & Certificates:</strong>
        <span style="font-weight:600;">
          {{ required_levels|join:", " }}
        </span>
        <br>
        <small>(UG + PG are always mandatory. Additional items appear based on Department selection.)</small>
      </div>

      {% if error %}
        <div class="error-box"><strong>Error:</strong> {{ error }}</div>
      {% endif %}

      <h2 class="section-title">Educational Qualifications</h2>

      <div id="edu-container">
        {% for edu in education %}
        <div class="education-block" data-index="{{ forloop.counter }}">
          <div class="education-header">
            <h3>Qualification #{{ forloop.counter }}</h3>

            {% if forloop.counter > 2 %}
              <button type="button" class="btn btn-remove" onclick="removeEdu(this)">Remove</button>
            {% endif %}
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="required">Category</label>
              <select name="category[]" class="form-control">
                <option value="">Select Category</option>
                {% for lvl in levels %}
                  <option value="{{ lvl.id }}"
                    {% if edu.category|stringformat:"s" == lvl.id|stringformat:"s" %}selected{% endif %}>
                    {{ lvl.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label class="required">Degree</label>
              <select name="degree[]" class="form-control">
                <option value="">Select Degree</option>
                {% for deg in degrees %}
                  <option value="{{ deg.id }}"
                    {% if edu.degree|stringformat:"s" == deg.id|stringformat:"s" %}selected{% endif %}>
                    {{ deg.degree_code }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label>Specialization</label>
              <input type="text" name="specialization[]" class="form-control" value="{{ edu.specialization|default:'' }}">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="required">Year of Passing</label>
              <input type="number" name="year_of_passing[]" class="form-control" value="{{ edu.year_of_passing|default:'' }}">
            </div>
            <div class="form-group">
              <label class="required">Institution</label>
              <input type="text" name="institution[]" class="form-control" value="{{ edu.institution|default:'' }}">
            </div>
            <div class="form-group">
              <label class="required">University / Board</label>
              <input type="text" name="university[]" class="form-control" value="{{ edu.university|default:'' }}">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="required">Percentage / CGPA</label>
              <input type="text" name="percentage[]" class="form-control" value="{{ edu.percentage|default:'' }}">
            </div>
            <div class="form-group">
              <label>Class Obtained</label>
              <select name="class_obtained[]" class="form-control">
                <option value="">Select Class</option>
                <option value="First Class" {% if edu.class_obtained == "First Class" %}selected{% endif %}>First Class</option>
                <option value="Second Class" {% if edu.class_obtained == "Second Class" %}selected{% endif %}>Second Class</option>
                <option value="Distinction" {% if edu.class_obtained == "Distinction" %}selected{% endif %}>Distinction</option>
                <option value="Pass" {% if edu.class_obtained == "Pass" %}selected{% endif %}>Pass</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label class="required">Upload Original Certificate</label>
              <input type="file" name="edu_certificate[]" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
              {% if edu.certificate_name %}
                <small class="success-note">Uploaded: {{ edu.certificate_name }}</small>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <button type="button" class="btn btn-add" onclick="addEdu()">+ Add More Qualification (PhD/HSC/SSLC)</button>

      <h2 class="section-title">Additional Educational Details</h2>

      <div class="form-row">
        <div class="form-group">
          <label>Mode of UG Study</label>
          <select name="mode_ug" class="form-control">
            <option value="">Select Mode</option>
            <option value="Regular" {% if research.mode_ug == "Regular" %}selected{% endif %}>Regular</option>
            <option value="Correspondence" {% if research.mode_ug == "Correspondence" %}selected{% endif %}>Correspondence</option>
            <option value="Distance" {% if research.mode_ug == "Distance" %}selected{% endif %}>Distance</option>
            <option value="Online" {% if research.mode_ug == "Online" %}selected{% endif %}>Online</option>
          </select>
        </div>

        <div class="form-group">
          <label>Mode of PG Study</label>
          <select name="mode_pg" class="form-control">
            <option value="">Select Mode</option>
            <option value="Regular" {% if research.mode_pg == "Regular" %}selected{% endif %}>Regular</option>
            <option value="Correspondence" {% if research.mode_pg == "Correspondence" %}selected{% endif %}>Correspondence</option>
            <option value="Distance" {% if research.mode_pg == "Distance" %}selected{% endif %}>Distance</option>
            <option value="Online" {% if research.mode_pg == "Online" %}selected{% endif %}>Online</option>
          </select>
        </div>

        <div class="form-group">
          <label>Mode of PhD Study</label>
          <select name="mode_phd" class="form-control">
            <option value="">Select Mode</option>
            <option value="Regular" {% if research.mode_phd == "Regular" %}selected{% endif %}>Regular</option>
            <option value="Part-time" {% if research.mode_phd == "Part-time" %}selected{% endif %}>Part-time</option>
            <option value="Full-time" {% if research.mode_phd == "Full-time" %}selected{% endif %}>Full-time</option>
          </select>
        </div>
      </div>

      <!-- ✅ GATE + NET/SLET (with certificates) -->
      <div class="form-row">
        <div class="form-group">
          <label>GATE Score</label>
          <input type="text" name="gate_score" class="form-control" value="{{ research.gate_score|default:'' }}">
          <span class="help-text">If you enter GATE score, uploading GATE certificate is mandatory.</span>
          <input type="file" name="gate_certificate" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
          {% if research_tmp.gate_certificate_name %}
            <small class="success-note">Uploaded: {{ research_tmp.gate_certificate_name }}</small>
          {% endif %}
        </div>

        <div class="form-group">
          <label>NET/SLET Score</label>
          <input type="text" name="net_slet_score" class="form-control" value="{{ research.net_slet_score|default:'' }}">
          <span class="help-text">If you enter NET/SLET score, uploading NET/SLET certificate is mandatory.</span>
          <input type="file" name="net_slet_certificate" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
          {% if research_tmp.net_slet_certificate_name %}
            <small class="success-note">Uploaded: {{ research_tmp.net_slet_certificate_name }}</small>
          {% endif %}
        </div>
      </div>

      <!-- ✅ Thesis Title (only PhD retained) -->
      <div class="form-row">
        <div class="form-group full-width">
          <label>PhD Thesis Title</label>
          <textarea name="phd_thesis_title" class="form-control" rows="3">{{ research.phd_thesis_title|default:'' }}</textarea>
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="btn btn-prev" onclick="window.location.href='{% url 'individual_data_sheet' %}'">← Previous</button>
        <button type="submit" class="btn btn-next">Save & Next →</button>
      </div>
    </form>

{% endblock %}

{% block extra_js %}
<script>
  function addEdu(){
    const container = document.getElementById('edu-container');
    const blocks = container.querySelectorAll('.education-block');
    const newIndex = blocks.length + 1;

    const firstBlock = blocks[0];
    const newBlock = firstBlock.cloneNode(true);

    newBlock.setAttribute('data-index', newIndex);
    newBlock.querySelector('.education-header h3').textContent = `Qualification #${newIndex}`;

    const header = newBlock.querySelector('.education-header');
    header.querySelectorAll('.btn-remove').forEach(b => b.remove());

    if(newIndex >= 3){
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-remove';
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = function(){ removeEdu(removeBtn); };
      header.appendChild(removeBtn);
    }

    newBlock.querySelectorAll('input[type="text"], input[type="number"]').forEach(i => i.value = '');
    newBlock.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
    newBlock.querySelectorAll('textarea').forEach(t => t.value = '');
    newBlock.querySelectorAll('input[type="file"]').forEach(f => f.value = '');

    const note = newBlock.querySelector('.success-note');
    if(note) note.remove();

    container.appendChild(newBlock);
    renumber();
  }

  function removeEdu(btn){
    const container = document.getElementById('edu-container');
    const blocks = container.querySelectorAll('.education-block');
    const block = btn.closest('.education-block');

    if(blocks.length <= 2){
      alert("UG and PG are mandatory. You cannot remove them.");
      return;
    }

    block.remove();
    renumber();
  }

  function renumber(){
    const container = document.getElementById('edu-container');
    const blocks = container.querySelectorAll('.education-block');

    blocks.forEach((b, idx) => {
      b.setAttribute('data-index', idx + 1);
      b.querySelector('.education-header h3').textContent = `Qualification #${idx + 1}`;

      const header = b.querySelector('.education-header');
      header.querySelectorAll('.btn-remove').forEach(x => x.remove());

      if(idx >= 2){
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-remove';
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = function(){ removeEdu(removeBtn); };
        header.appendChild(removeBtn);
      }
    });
  }
</script>
{% endblock %}
