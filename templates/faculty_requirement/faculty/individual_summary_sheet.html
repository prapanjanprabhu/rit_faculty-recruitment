{% load static %}
{% load faculty_tags %}
{% departments as departments %}
{% designations as designations %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individual Summary Sheet</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Calibri','Segoe UI',sans-serif;background:#f8f9fa;padding:20px;color:#333}.container{max-width:1100px;margin:0 auto;background:white;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden;border:1px solid #ddd}.header{background:#003366;color:white;padding:20px;text-align:center;border-bottom:4px solid #ffcc00}.header h1{font-size:24px;margin-bottom:5px;font-weight:600}.header p{font-size:14px;opacity:.9}.form-section{padding:25px}.section-title{color:#003366;font-size:18px;font-weight:600;margin:25px 0 15px;padding-bottom:8px;border-bottom:2px solid #e0e0e0}.form-row{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:15px}.form-group{flex:1;min-width:200px;margin-bottom:15px}label{display:block;margin-bottom:5px;color:#003366;font-weight:500;font-size:14px}.required:after{content:" *";color:#d32f2f}.form-control,select{width:100%;padding:8px 12px;border:1px solid #ccc;border-radius:4px;font-size:14px}.form-control:focus,select:focus{outline:none;border-color:#003366}.btn{padding:8px 20px;border:none;border-radius:4px;cursor:pointer;font-size:14px;transition:.3s}.btn-next{background:#003366;color:white}.btn-next:hover{background:#002244}.button-group{display:flex;justify-content:flex-end;margin-top:30px;padding-top:20px;border-top:1px solid #eee}.instructions{background:#e7f1ff;border-left:3px solid #003366;padding:10px 15px;margin-bottom:20px;font-size:13px}.stats-row{display:flex;flex-wrap:wrap;gap:10px;background:#f5f7fa;padding:15px;border-radius:4px}.stats-group{flex:1;min-width:120px}.stats-input{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;text-align:center}.full-width{flex:1 0 100%}.image-preview-container{margin-top:15px;text-align:center}.image-preview{max-width:100%;max-height:200px;border-radius:8px;border:2px solid #ddd;display:none}.qualification-section{margin-bottom:20px}.qualification-row{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:10px}.qualification-row .form-group{flex:1;min-width:150px}.add-qualification-btn{background:#4CAF50;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;margin-top:5px;font-size:14px}.remove-qualification-btn{background:#f44336;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;margin-top:10px;font-size:12px}.research-section{background:#f9f9f9;padding:15px;border-radius:5px;margin-bottom:20px;border:1px solid #e0e0e0}.research-row{display:flex;margin-bottom:10px;align-items:center}.research-label{width:200px;font-weight:500;color:#555}.research-input-group{display:flex;gap:15px}.research-input-item{display:flex;flex-direction:column}.research-input-item label{font-size:12px;color:#666;margin-bottom:3px}.research-input{width:80px;padding:6px;border:1px solid #ccc;border-radius:4px;text-align:center}.students-section{background:#f9f9f9;padding:15px;border-radius:5px;margin-bottom:20px;border:1px solid #e0e0e0}.students-row{display:flex;margin-bottom:15px;align-items:center}.students-type{width:200px;font-weight:500;color:#555}.students-input-group{display:flex;gap:20px}.projects-table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}.projects-table th{background-color:#003366;color:white;padding:10px;text-align:left;border:1px solid #ddd}.projects-table td{padding:10px;border:1px solid #ddd}.projects-table input{width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box}.add-project-row{background-color:#4CAF50;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;margin-top:10px;font-size:14px}.remove-project-row{background-color:#f44336;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:12px}@media (max-width:768px){.form-group,.stats-group{min-width:100%}.button-group{justify-content:center}.btn{width:100%}.research-row,.students-row{flex-direction:column;align-items:flex-start}.research-label,.students-type{width:100%;margin-bottom:5px}.projects-table th,.projects-table td{padding:5px;font-size:12px}}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Individual Summary Sheet</h1>
        <p>Summary of your professional background and qualifications</p>
    </div>
    <div class="form-section">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="instructions">
                <p><strong>Instructions:</strong> Fill all summary information accurately. Fields marked * are mandatory.</p>
            </div>
            <h2 class="section-title">Profile Photo</h2>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Upload Photograph</label>

                    <input type="file" name="photo" id="photoInput" class="form-control">

                    {% if data.photo_name %}
                        <small style="display:block;margin-top:6px;color:#555;">
                            ðŸ“Ž Uploaded file: <strong>{{ data.photo_name }}</strong>
                        </small>
                    {% endif %}

    <div class="image-preview-container">
        {% if data.photo %}
            <img
                id="imagePreview"
                src="{{ MEDIA_URL }}{{ data.photo }}"
                class="image-preview"
                style="display:block;"
            >
        {% else %}
            <img id="imagePreview" class="image-preview">
        {% endif %}
    </div>
</div>
            </div>
            <h2 class="section-title">Application Details</h2>
            <div class="form-row">
                <div class="form-group">
    <label class="required">Position Applied For</label>
    <select name="position_applied" class="form-control" required>
        <option value="" {% if not data or not data.id %}selected{% endif %}>
            Select Position
        </option>

        {% for d in designations %}
            <option value="{{ d.id }}"
                {% if data and data.position_applied and data.position_applied.id == d.id %}
                    selected
                {% endif %}
            >
                {{ d.name }}
            </option>
        {% endfor %}
    </select>
</div>

                <div class="form-group">
    <label class="required">Department</label>
    <select name="department" class="form-control" required>
        <option value="" {% if not data or not data.id %}selected{% endif %}>
            Select Department
        </option>

        {% for dept in departments %}
            <option value="{{ dept.id }}"
                {% if data and data.department and data.department.id == dept.id %}
                    selected
                {% endif %}
            >
              {{ dept.degree.degree_code }} - {{ dept.name }} ({{ dept.code }})
            </option>
        {% endfor %}
    </select>
</div>

            </div>
            <h2 class="section-title">Candidate Information</h2>
            <div class="form-row">
                <div class="form-group">
                    <label class="required">Full Name</label>
                    <input type="text" name="name" class="form-control" value="{{ data.name|default:'' }}">
                </div>
                <div class="form-group">
                    <label class="required">Age</label>
                    <input type="number" name="age" class="form-control" value="{{ data.age|default:'' }}">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
    <label class="required">Present Designation</label>
    <select name="present_designation" class="form-control" required>
        <option value="" {% if not data or not data.id %}selected{% endif %}>
            Select Present Designation
        </option>

        {% for d in designations %}
            <option value="{{ d.id }}"
                {% if data and data.present_designation and data.present_designation.id == d.id %}
                    selected
                {% endif %}
            >
                {{ d.name }}
            </option>
        {% endfor %}
    </select>
</div>

                <div class="form-group">
                    <label class="required">Organization</label>
                    <input type="text" name="present_organization" class="form-control" value="{{ data.present_organization|default:'' }}">
                </div>
            </div>
           

<h2 class="section-title">Qualifications</h2>

<div class="qualification-section" id="qualifications-container">

{% if data.qualifications %}
    {% for q in data.qualifications %}
    <div class="qualification-row">

        <div class="form-group">
            <label>Qualification</label>
            <select name="qualification[]" class="form-control">
                <option value="">Select Qualification</option>
                {% for deg in degrees %}
                    <option value="{{ deg.id }}"
                        {% if q.qualification.id == deg.id %}selected{% endif %}>
                        {{ deg.degree_code }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Specialization</label>
            <input type="text" name="specialization[]" class="form-control"
                   value="{{ q.specialization }}">
        </div>

        <div class="form-group">
            <label>University/Institute</label>
            <input type="text" name="institute[]" class="form-control"
                   value="{{ q.institute }}">
        </div>

        <div class="form-group">
            <label>Year</label>
            <input type="number" name="year[]" class="form-control"
                   value="{{ q.year }}">
        </div>

        {% if not forloop.first %}
        <div class="form-group">
            <label>&nbsp;</label>
            <button type="button" class="remove-qualification-btn"
                    onclick="removeQualification(this)">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
        {% endif %}

    </div>
    {% endfor %}
{% else %}
    <div class="qualification-row">
        <div class="form-group">
            <label>Qualification</label>
            <select name="qualification[]" class="form-control">
                <option value="">Select Qualification</option>
                {% for deg in degrees %}
                    <option value="{{ deg.id }}">
                        {{ deg.degree_code }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Specialization</label>
            <input type="text" name="specialization[]" class="form-control">
        </div>

        <div class="form-group">
            <label>University/Institute</label>
            <input type="text" name="institute[]" class="form-control">
        </div>

        <div class="form-group">
            <label>Year</label>
            <input type="number" name="year[]" class="form-control" min="1950" max="2030">
        </div>
    </div>
{% endif %}

</div>

<button type="button" class="add-qualification-btn" id="add-qualification">
    <i class="fas fa-plus"></i> Add Another Qualification
</button>

            <div class="form-row">
                <div class="form-group full-width">
                    <label class="required">Overall Specialization</label>
                    <input type="text" name="overall_specialization" class="form-control" value="{{ data.overall_specialization|default:'' }}" placeholder="Your primary area of specialization">
                </div>
            </div>
            <h2 class="section-title">Years of Service</h2>
            <div class="stats-row">
                <div class="stats-group">
                    <label>Assistant Professor</label>
                    <input type="number" name="assistant_professor_years" class="stats-input" value="{{ data.assistant_professor_years|default:'' }}">
                </div>
                <div class="stats-group">
                    <label>Associate Professor</label>
                    <input type="number" name="associate_professor_years" class="stats-input" value="{{ data.associate_professor_years|default:'' }}">
                </div>
                <div class="stats-group">
                    <label>Professor</label>
                    <input type="number" name="professor_years" class="stats-input" value="{{ data.professor_years|default:'' }}">
                </div>
                <div class="stats-group">
                    <label>Others</label>
                    <input type="number" name="other_years" class="stats-input" value="{{ data.other_years|default:'' }}">
                </div>
            </div>
            <h2 class="section-title">Research & Industry Experience</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Research Experience (Years)</label>
                    <input type="number" name="research_experience_years" class="form-control" value="{{ data.research_experience_years|default:'' }}">
                </div>
                <div class="form-group">
                    <label>Industry Experience (Years)</label>
                    <input type="number" name="industry_experience_years" class="form-control" value="{{ data.industry_experience_years|default:'' }}">
                </div>
            </div>
            <h2 class="section-title">No. of Research Publications</h2>
            <div class="research-section">
                <div class="research-row">
                    <div class="research-label">In Journals:</div>
                    <div class="research-input-group">
                        <div class="research-input-item">
                            <label>National</label>
                            <input type="number" name="journal_national" class="research-input" value="{{ data.journal_national|default:'0' }}">
                        </div>
                        <div class="research-input-item">
                            <label>International</label>
                            <input type="number" name="journal_international" class="research-input" value="{{ data.journal_international|default:'0' }}">
                        </div>
                    </div>
                </div>
                <div class="research-row">
                    <div class="research-label">In Conferences:</div>
                    <div class="research-input-group">
                        <div class="research-input-item">
                            <label>National</label>
                            <input type="number" name="conference_national" class="research-input" value="{{ data.conference_national|default:'0' }}">
                        </div>
                        <div class="research-input-item">
                            <label>International</label>
                            <input type="number" name="conference_international" class="research-input" value="{{ data.conference_international|default:'0' }}">
                        </div>
                    </div>
                </div>
            </div>
            <h2 class="section-title">No. of Students Guided</h2>
            <div class="students-section">
                <div class="students-row">
                    <div class="students-type">M.E./M.Tech./ M.Phil.:</div>
                    <div class="students-input-group">
                        <div class="research-input-item">
                            <label>Completed</label>
                            <input type="number" name="mtech_completed" class="research-input" value="{{ data.mtech_completed|default:'0' }}">
                        </div>
                        <div class="research-input-item">
                            <label>On-going</label>
                            <input type="number" name="mtech_ongoing" class="research-input" value="{{ data.mtech_ongoing|default:'0' }}">
                        </div>
                    </div>
                </div>
                <div class="students-row">
                    <div class="students-type">No. of Research Scholars for M.S./Ph.D.:</div>
                    <div class="students-input-group">
                        <div class="research-input-item">
                            <label>Completed</label>
                            <input type="number" name="phd_completed" class="research-input" value="{{ data.phd_completed|default:'0' }}">
                        </div>
                        <div class="research-input-item">
                            <label>On-going</label>
                            <input type="number" name="phd_ongoing" class="research-input" value="{{ data.phd_ongoing|default:'0' }}">
                        </div>
                    </div>
                </div>
            </div>
            <h2 class="section-title">Completed Sponsored Projects</h2>
            <table class="projects-table" id="projects-table">
                <thead>
                    <tr>
                        <th>Title of Project</th>
                        <th>Duration</th>
                        <th>Amount (Rs.)</th>
                        <th>Sponsoring Agency</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="projects-body">
                    {% if data.projects %}
                        {% for p in data.projects %}
                        <tr>
                            <td>
                                <input type="text" name="project_title[]" value="{{ p.title }}">
                            </td>
                            <td>
                                <input type="text" name="project_duration[]" value="{{ p.duration }}">
                            </td>
                            <td>
                                <input type="number" name="project_amount[]" value="{{ p.amount }}">
                            </td>
                            <td>
                                <input type="text" name="project_agency[]" value="{{ p.agency }}">
                            </td>
                            <td>
                                {% if not forloop.first %}
                                <button type="button" class="remove-project-row"
                                        onclick="removeProjectRow(this)">Remove</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% elif data.project_title %}
                        {% for p in data.project_title %}
                        <tr>
                            <td><input type="text" name="project_title[]" value="{{ p }}"></td>
                            <td><input type="text" name="project_duration[]" value="{{ data.project_duration|index:forloop.counter0 }}"></td>
                            <td><input type="number" name="project_amount[]" value="{{ data.project_amount|index:forloop.counter0 }}"></td>
                            <td><input type="text" name="project_agency[]" value="{{ data.project_agency|index:forloop.counter0 }}"></td>
                            <td>{% if not forloop.first %}<button type="button" class="remove-project-row" onclick="removeProjectRow(this)">Remove</button>{% endif %}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td><input type="text" name="project_title[]" placeholder="Enter project title"></td>
                            <td><input type="text" name="project_duration[]" placeholder="e.g., 2020-2022"></td>
                            <td><input type="number" name="project_amount[]" placeholder="Amount in Rs."></td>
                            <td><input type="text" name="project_agency[]" placeholder="Sponsoring agency"></td>
                            <td></td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
            <button type="button" class="add-project-row" id="add-project-row"><i class="fas fa-plus"></i> Add Project Row</button>
            <h2 class="section-title">Community Information</h2>
            <div class="form-row">
                <div class="form-group full-width">
                    <label>Community & Caste</label>
                    <input type="text" name="community_and_caste" class="form-control" value="{{ data.community_and_caste|default:'' }}">
                </div>
            </div>
            <div class="button-group">
                <button type="submit" class="btn btn-next">Save & Next <i class="fas fa-arrow-right"></i></button>
            </div>
        </form>
    </div>
</div>
<script>
// ================= IMAGE PREVIEW =================
document.getElementById('photoInput').addEventListener('change', function (e) {
    const file = e.target.files[0];
    const preview = document.getElementById('imagePreview');

    if (file) {
        const reader = new FileReader();
        reader.onload = function (ev) {
            preview.src = ev.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

// ================= ADD QUALIFICATION (FIXED) =================
document.getElementById('add-qualification').addEventListener('click', function () {
    const container = document.getElementById('qualifications-container');
    const row = document.createElement('div');
    row.className = 'qualification-row';

    row.innerHTML = `
        <div class="form-group">
            <label>Qualification</label>
            <select name="qualification[]" class="form-control">
                <option value="">Select Qualification</option>
                {% for deg in degrees %}
                    <option value="{{ deg.id }}">
                        {{ deg.degree_code }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Specialization</label>
            <input type="text" name="specialization[]" class="form-control" placeholder="Enter specialization">
        </div>

        <div class="form-group">
            <label>University/Institute</label>
            <input type="text" name="institute[]" class="form-control" placeholder="Enter university/institute">
        </div>

        <div class="form-group">
            <label>Year</label>
            <input type="number" name="year[]" class="form-control" min="1950" max="2030" placeholder="Year">
        </div>

        <div class="form-group">
            <label>&nbsp;</label>
            <button type="button" class="remove-qualification-btn" onclick="removeQualification(this)">
                <i class="fas fa-trash"></i> Remove
            </button>
        </div>
    `;

    container.appendChild(row);
});

// ================= REMOVE QUALIFICATION =================
function removeQualification(btn) {
    const row = btn.closest('.qualification-row');
    if (row) row.remove();
}

// ================= ADD PROJECT ROW =================
document.getElementById('add-project-row').addEventListener('click', function () {
    const tbody = document.getElementById('projects-body');
    const tr = document.createElement('tr');

    tr.innerHTML = `
        <td><input type="text" name="project_title[]" placeholder="Enter project title"></td>
        <td><input type="text" name="project_duration[]" placeholder="e.g., 2020-2022"></td>
        <td><input type="number" name="project_amount[]" placeholder="Amount in Rs."></td>
        <td><input type="text" name="project_agency[]" placeholder="Sponsoring agency"></td>
        <td>
            <button type="button" class="remove-project-row" onclick="removeProjectRow(this)">
                Remove
            </button>
        </td>
    `;
    tbody.appendChild(tr);
});

// ================= REMOVE PROJECT ROW =================
function removeProjectRow(btn) {
    const row = btn.closest('tr');
    if (document.querySelectorAll('#projects-body tr').length > 1) {
        row.remove();
    }
}

// ================= REQUIRED FIELD VALIDATION =================
document.querySelector('form').addEventListener('submit', function (e) {
    let valid = true;

    document.querySelectorAll('.required').forEach(label => {
        const field = label.closest('.form-group').querySelector('input, select');
        if (!field.value.trim()) {
            valid = false;
            field.style.borderColor = '#d32f2f';
        } else {
            field.style.borderColor = '#ccc';
        }
    });

    if (!valid) {
        e.preventDefault();
        alert('Please fill all required fields (*)');
    }
});

// ================= DOM READY =================
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('input[type="number"]').forEach(i => {
        i.addEventListener('input', function () {
            if (this.value < 0) this.value = 0;
        });
    });

    const img = document.getElementById('imagePreview');
    if (img && img.src && img.src.trim() !== '') {
        img.style.display = 'block';
    }
});
</script>

</body>
</html>